name: Build Decanter

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build:

    runs-on: ubuntu-latest
    container: ubuntu:25.10

    steps:

    - name: Install System Dependencies
      run: |
        apt-get update
        apt-get install -y git ghc cabal-install libgtk-4-dev libadwaita-1-dev libgirepository1.0-dev wine
        apt-get install -y libghc-haskell-gi-base-dev libghc-gi-gio-dev libghc-gi-glib-dev libghc-typed-process-dev libghc-async-dev libghc-hspec-dev hspec-discover

    - name: Print Installed Versions
      run: |
        apt show libgtk-4-dev
        ghc --version
        cabal --version
        wine --version

    - uses: actions/checkout@v4

    - name: Cache
      uses: actions/cache@v3
      env:
        cache-name: cache-cabal
      with:
        path: ~/.cabal
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/*.cabal') }}-${{ hashFiles('**/cabal.project') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ env.cache-name }}-
          ${{ runner.os }}-build-
          ${{ runner.os }}-

    - name: Install dependencies
      run: |
        cabal update
        cabal build --only-dependencies --enable-tests --enable-benchmarks

    - name: Build
      run: cabal build --enable-tests --enable-benchmarks all

    - name: Run Tests
      run: cabal test

    - name: Locate Executable
      if: success()
      run: |
        mkdir -p build-artifacts
        # Finde das kompilierte Binary (executable permission) und kopiere es
        find dist-newstyle -name decanter -type f -perm -u+x -exec cp {} build-artifacts/ \;

    - name: Upload Executable
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: decanter-executable
        path: build-artifacts/decanter

    - name: Gather Test Logs
      if: always() # Auch ausf√ºhren, wenn Tests fehlschlagen
      run: |
        mkdir -p test-logs
        # Sucht rekursiv nach .log Dateien im dist-newstyle Verzeichnis (dort liegen die Test-Reports)
        find dist-newstyle -name "*.log" -type f -exec cp {} test-logs/ \;

    - name: Upload Test Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs
        path: test-logs/
